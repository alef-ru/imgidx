<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find similar image</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <script>
        function addImage() {
            const imgUrl = document.getElementById("add_img_url").value;
            const attrs = document.getElementById("add_img_attrs").value;
            const resultDiv = document.getElementById("add_img_result");
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/images/", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 400)) {
                    const json = JSON.parse(xhr.responseText);
                    resultDiv.innerHTML = json.message;
                    if (xhr.status === 400) {
                        resultDiv.style.color = "red";
                    } else {
                        resultDiv.style.color = "green";
                    }
                }
            };
            const data = `{"url": "${imgUrl}" , "attrs": ${attrs ? attrs : '"no additional info specified"'}}`;
            xhr.send(data);
        }

        function findSimilarImg(how) {
            const resultDiv = document.getElementById("find_img_result")
            const xhr = new XMLHttpRequest();
            let formData = null
            if (how === 'by URL') {
                const imgUrl = document.getElementById("find_img_url").value;
                xhr.open("GET", `/images/${encodeURIComponent(imgUrl)}`, true);
            } else if (how === 'by file') {
                const inputFile = document.getElementById("orig_image");
                const file = inputFile.files[0];
                formData = new FormData();
                formData.append("image-file", file);
                xhr.open("POST", "/find-similar-to-file/", true);
            } else {
                throw new Error('Unknown "how"');
            }
            resultDiv.style.color = null;
            resultDiv.innerHTML = 'Working...';

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 400)) {
                    const json = JSON.parse(xhr.responseText);
                    if (xhr.status === 400) {
                        resultDiv.style.color = "red";
                        resultDiv.innerHTML = json.message;
                    } else {
                        resultDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h4>The original image</h4>
                                <img style="width: 100%;" id="original-image">
                            </div>
                            <div class="col-md-6">
                                <h4>The nearest image in the index</h4>
                                <img src="${json.url}" style="width: 100%;" class="img-fluid">
                            </div>
                        </div>
                        <p><strong>Distance:</strong> ${json.distance}</p>
                        <p><strong>Additional attributes:</strong><code>${JSON.stringify(json.additional_details)}</code></p>`;
                        const originalImage = document.getElementById("original-image")
                        if (how === 'by URL') {
                            const imgUrl = document.getElementById("find_img_url").value;
                            originalImage.src = imgUrl
                        } else if (how === 'by file') {
                            const inputFile = document.getElementById("orig_image");
                            const file = inputFile.files[0];
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onload = readerEvent => {
                                originalImage.src = readerEvent.target.result;
                            }
                        } else {
                            throw new Error('Unknown "how"');
                        }
                    }
                }
            };
            xhr.send(formData);
        }
    </script>
</head>
<body class="bg-light">
<div class="container ">
    <div class="row">
        <h4 class="mt-5">Add image to the index</h4>
        <div class="col-md">
            <label class="form-label" for="add_img_url">Image URL</label>
            <input type="text" class="form-control" id="add_img_url" placeholder="https://somehost.com/image.jpeg"/>
        </div>
        <div class="col-md">
            <label class="form-label" for="add_img_attrs">Additional details (valid JSON)</label>
            <input type="text" class="form-control" id="add_img_attrs"
                   placeholder='{"id": 123, "category": "thumbnail"}'/>
        </div>
    </div>
    <input type="button" value="Add" class="w-100 btn btn-primary mt-2 mb-2" onclick="addImage()">
    <div class="row">
        <div class="col" id="add_img_result"></div>
    </div>

    <hr/>

    <h4 class="mt-5">Find similar image by URL or file</h4>
    <div class="row">
        <div class="col-md">
            <div class="row align-items-end">
                <div class="col">
                    <label class="form-label" for="find_img_url">Image URL</label>
                    <input class="form-control" type="text" id="find_img_url"
                           placeholder="https://somehost.com/image.jpeg"/>
                </div>
                <div class="col-2">
                    <input type="button" class="btn btn-primary" value="Find"
                           onclick="findSimilarImg('by URL')"/>
                </div>
            </div>
        </div>
        <div class="col-md">
            <div class="row align-items-end">
                <div class="col">
                    <label class="form-label" for="orig_image">Image file</label>
                    <input class="form-control" type="file" id="orig_image"/>
                </div>
                <div class="col-2">
                    <input type="button" class="btn btn-primary" value="Find" id="find_by_file"
                           onclick="findSimilarImg('by file')"/>
                </div>

            </div>
        </div>
    </div>
    <div id="find_img_result" class="mt-5"></div>
</div>
</body>
</html>